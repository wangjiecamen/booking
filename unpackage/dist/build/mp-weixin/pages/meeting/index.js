"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/date.js"),o=require("../../utils/user.js"),a=require("../../wxcomponents/vant/dialog/dialog.js");if(!Array){e.resolveComponent("van-dialog")()}Math||r();const r=()=>"../../components/AddBtn.js",l={__name:"index",setup(r){e.useCssVars((t=>({ba685cb0:e.unref(v),"503565c8":d.value})));const l=t.getWeekStr(),i=e.ref(0),n=e.ref(0),d=e.ref("200rpx"),s=e.ref(!1),c=t.getTimeList();let m=null,u={},f=[],_=!1,h=!1;const g=e.ref([]),p=e.computed((()=>{const e=t.getWeeks()[i.value].getMonth()+1;return String(e).padStart(2,"0")})),v=e.computed((()=>g.value.length*parseInt(d.value)+"rpx")),b=e.computed((()=>(new Date).getFullYear()+"-"+p.value+"-"+l[i.value].d)),I=e=>{n.value=-e.detail.scrollTop},T=()=>{const t=f.filter((e=>e.selected)),o=new Set;t.forEach((e=>{e.defaultSelected&&o.add(e.id)})),console.log(o);const r=t[0].time;let l=t[t.length-1].time;const[i,n]=l.split(":");if("00"===n&&(l=i+":30"),"30"===n&&(l=Number(i)+1+":00"),0===o.size){const o=e.index.getStorageSync("userinfo"),a={room_id:t[0].roomId,audit:t[0].roomAudit,start_time:r,end_time:l,date:b.value,room_name:t[0].roomName,branch_name:o.branchName,branch_id:o.branchId,user_id:o._id,user_name:o.username};e.index.navigateTo({url:`/pages/meeting-record/detail?form=${encodeURIComponent(JSON.stringify(a))}`})}else{if(1!==o.size)return a.Dialog.confirm({showCancelButton:!1,message:"已存在多个会议，不可修改"});{const t=o.values().next().value;e.index.navigateTo({url:`/pages/meeting-record/detail?id=${t}&type=edit&end_time=${l}&start_time=${r}`})}}},x=e=>(g.value.find((t=>t.roomId===e))||{}).cell||[],S=async()=>{const{data:o}=await e.Ls.importObject("room").getRoomListWithBooking(b.value);g.value=o.map((o=>{o.cell=[];const a=(o=>{let a=[];return o.forEach((o=>{if(o.start_time&&o.end_time){const[r,l]=o.start_time.split(":"),[i,n]=o.end_time.split(":");let d=t.getTimeList(r,i);"30"===l&&(d=e.lodash_drop(d,1)),"30"===n&&(d=e.lodash_dropright(d,1)),"00"===n&&(d=e.lodash_dropright(d,2));const s=d.map((e=>({id:o._id,branch_name:o.branch_name,branch_id:o.branch_id,remark:o.remark,user_id:o.user_id,time:e})));a.push(...s)}})),a})(o.meeting);let r=0,l="",i="";for(let e of c){const t=a.findIndex((t=>t.time===e));-1!==t?(i=a[t].id,l!==i&&(r=0),r++,o.cell.push({...1==r&&{label:a[t].branch_name},roomId:o.roomId,roomName:o.roomName,roomAudit:o.roomAudit,defaultSelected:!0,selected:!1,time:e,id:a[t].id,branch_name:a[t].branch_name,branch_id:a[t].branch_id,user_id:a[t].user_id,remark:a[t].remark,selectedByTapTime:!1}),l=i):(r=0,o.cell.push({roomAudit:o.roomAudit,roomName:o.roomName,roomId:o.roomId,defaultSelected:!1,selected:!1,time:e,selectedByTapTime:!1}))}return o})),console.log(g.value)};return e.onShow((()=>{console.log("on show...."),S()})),(t,r)=>e.e({a:e.t(e.unref(p)),b:e.f(e.unref(l),((t,o,a)=>({a:e.t(t.s),b:e.t(t.d),c:e.o((e=>(e=>{s.value=!1,i.value=e,S()})(o)),o),d:i.value===o?1:"",e:o}))),c:e.s(t.__cssVars()),d:e.f(e.unref(c),((t,o,a)=>({a:e.t(t),b:e.o((e=>(e=>{for(let t of g.value)t.cell[e].selectedByTapTime=!t.cell[e].selectedByTapTime;if(null!==m){if(h){for(let t of g.value)t.cell.forEach(((t,o)=>t.selectedByTapTime=o===e));return m=e,void(h=!1)}const t=Math.min(m,e),o=Math.max(m,e);let a=t;for(;o-a>0;){for(let e of g.value)e.cell[a].selectedByTapTime=!0;a++}h=!0}m=e})(o)),o),c:o}))),e:e.o(I),f:e.f(g.value,((t,r,l)=>({a:e.t(t.roomName),b:e.f(t.cell,((t,l,i)=>e.e({a:t.label},t.label?{b:e.t(t.label)}:{},{c:t.selected?1:"",d:t.defaultSelected?1:"",e:t.selectedByTapTime?1:"",f:e.o((a=>(t=>{if(o.isAdmin())return;const a=o.getUserInfo()._id;if(t.defaultSelected){const o=a===t.user_id?"edit":"detail";e.index.navigateTo({url:`/pages/meeting-record/detail?id=${t.id}&type=${o}`})}})(t)),r+"_"+l),g:e.o((e=>((e,t)=>{const r=o.getUserInfo().branchId;if(e.selected=!e.selected,f=x(e.roomId),u.roomId!==e.roomId)x(u.roomId).forEach((e=>e.selected=!1)),_=!1;else{const t=c.findIndex((t=>t===e.time));if(_)return f.forEach(((e,o)=>f[o].selected=o===t)),_=!1,void(u=e);const o=c.findIndex((e=>e===u.time)),l=Math.min(o,t),i=Math.max(o,t);let n=l;for(;i-n>0;){if(f[n].defaultSelected&&f[n].branch_id&&r&&r!==f[n].branch_id){a.Dialog.confirm({showCancelButton:!1,message:"会议室已被其他部门占用，请重新选择"}).then((()=>{f.forEach(((e,t)=>f[t].selected=!1)),s.value=!1}));break}n++,console.log(n),f[n].selected=!0}_=!0}u=e,s.value=!0})(t)),r+"_"+l),h:r+"_"+l}))),c:r}))),g:`translateY(${n.value}px)`,h:e.p({id:"van-dialog"}),i:e.s(t.__cssVars()),j:s.value&&e.unref(o.isUser)()},s.value&&e.unref(o.isUser)()?{k:e.o(T),l:e.s(t.__cssVars())}:{})}},i=e._export_sfc(l,[["__scopeId","data-v-34611fec"]]);wx.createPage(i);
